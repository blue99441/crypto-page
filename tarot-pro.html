<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tarot Draw â€” Sign in with Google</title>
<meta name="color-scheme" content="dark light">
<style>
/* ==== Professional minimal brand ==== */
:root{
  --bg:#0b0f14;
  --panel:#0f1524;
  --line:#1f2a44;
  --text:#e8eef8;
  --muted:#93a3c3;
  --accent:#6ad1ff;
  --accent2:#7cffb7;
  --danger:#ff8a8a;
  --warn:#ffd479;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC";background:var(--bg);color:var(--text)}
.container{max-width:980px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:14px}
.header{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--line);padding-bottom:12px}
.brand{display:flex;gap:10px;align-items:center}
.brand .logo{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:#04222a;font-weight:900}
.brand h1{margin:0;font-size:18px;letter-spacing:.3px}
.actions{display:flex;gap:8px;align-items:center}
.btn{padding:10px 14px;border:none;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#03202a;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.badge{font-size:12px;color:var(--muted)}
.panel{border:1px solid var(--line);border-radius:12px;background:var(--panel)}
.section{padding:14px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media (max-width:900px){ .grid{grid-template-columns:1fr} }
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0a111e;border:1px solid var(--line);border-radius:6px;padding:2px 6px}
.note{font-size:12px;color:var(--muted)}
.ok{color:#95ffad}.err{color:var(--danger)}.warn{color:var(--warn)}
.cards{display:flex;gap:12px;flex-wrap:wrap}
.card{flex:1 1 260px;border:1px solid var(--line);background:#0e1730;border-radius:12px;padding:12px}
.card h3{margin:0 0 6px 0;font-size:16px}
.list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px}
.item{border:1px solid var(--line);background:#0e1730;border-radius:10px;padding:10px}
.item .meta{font-size:12px;color:var(--muted);margin-bottom:4px}
footer{padding:8px;color:var(--muted);text-align:center;font-size:12px}
.hidden{display:none}
.divider{height:1px;background:var(--line);margin:10px 0}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo">ğŸ”®</div>
      <h1>Tarot Draw</h1>
    </div>
    <div class="actions">
      <span id="who" class="badge">æœªç™»å…¥</span>
      <button id="login" class="btn ghost">ä½¿ç”¨ Google ç™»å…¥</button>
      <button id="logout" class="btn ghost hidden">ç™»å‡º</button>
    </div>
  </div>

  <div class="grid">
    <!-- Draw -->
    <section class="panel">
      <div class="section">
        <div class="row" style="margin-bottom:10px">
          <button id="draw1" class="btn" disabled>æŠ½ 1 å¼µ</button>
          <button id="draw3" class="btn" disabled>æŠ½ 3 å¼µï¼ˆéå» / ç¾åœ¨ / æœªä¾†ï¼‰</button>
          <button id="clear" class="btn ghost" disabled>æ¸…ç©ºç•«é¢</button>
          <span id="saveState" class="note"></span>
        </div>
        <div id="results" class="cards"></div>
        <div class="divider"></div>
        <div class="note">æŠ½ç‰Œçµæœæœƒè‡ªå‹•å¯«å…¥ <span class="kbd">/tarot_draws/&lt;uid&gt;/</span>ï¼Œé‡æ–°æ•´ç†ä»æœƒä¿ç•™ã€‚</div>
      </div>
    </section>

    <!-- History -->
    <section class="panel">
      <div class="section">
        <h3 style="margin:0 0 6px 0">ğŸ“œ æˆ‘çš„æŠ½å¡æ­·å²</h3>
        <ul id="history" class="list"></ul>
      </div>
    </section>
  </div>

  <footer>Â© 2025 Tarot Draw</footer>
</div>

<!-- Firebase v10 compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
<script>
// ===== Firebase config (hardcoded to your project) =====
const firebaseConfig = {
  apiKey: "AIzaSyC4wMh3OF2yZC74P50HVSVC6juyiK_2iHY",
  authDomain: "coin-intel-chat.firebaseapp.com",
  databaseURL: "https://coin-intel-chat-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "coin-intel-chat",
  appId: "1:829267717115:web:7b0ae1ad3f6289d923b95e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
const GoogleProvider = new firebase.auth.GoogleAuthProvider();

// ===== DOM =====
const who = document.getElementById('who');
const loginBtn = document.getElementById('login');
const logoutBtn = document.getElementById('logout');
const draw1Btn = document.getElementById('draw1');
const draw3Btn = document.getElementById('draw3');
const clearBtn = document.getElementById('clear');
const results = document.getElementById('results');
const historyList = document.getElementById('history');
const saveState = document.getElementById('saveState');

// ===== State =====
let uid = null;

// ===== Tarot data =====
const MAJOR_ARCANA = [
  {n:0,en:"The Fool",zh:"æ„šè€…"},{n:1,en:"The Magician",zh:"é­”è¡“å¸«"},{n:2,en:"The High Priestess",zh:"å¥³ç¥­å¸"},
  {n:3,en:"The Empress",zh:"çš‡å"},{n:4,en:"The Emperor",zh:"çš‡å¸"},{n:5,en:"The Hierophant",zh:"æ•™çš‡"},
  {n:6,en:"The Lovers",zh:"æˆ€äºº"},{n:7,en:"The Chariot",zh:"æˆ°è»Š"},{n:8,en:"Strength",zh:"åŠ›é‡"},
  {n:9,en:"The Hermit",zh:"éš±è€…"},{n:10,en:"Wheel of Fortune",zh:"å‘½é‹ä¹‹è¼ª"},{n:11,en:"Justice",zh:"æ­£ç¾©"},
  {n:12,en:"The Hanged Man",zh:"åŠäºº"},{n:13,en:"Death",zh:"æ­»ç¥"},{n:14,en:"Temperance",zh:"ç¯€åˆ¶"},
  {n:15,en:"The Devil",zh:"æƒ¡é­”"},{n:16,en:"The Tower",zh:"é«˜å¡”"},{n:17,en:"The Star",zh:"æ˜Ÿæ˜Ÿ"},
  {n:18,en:"The Moon",zh:"æœˆäº®"},{n:19,en:"The Sun",zh:"å¤ªé™½"},{n:20,en:"Judgement",zh:"å¯©åˆ¤"},{n:21,en:"The World",zh:"ä¸–ç•Œ"}
];
function drawOne(){ const idx = Math.floor(Math.random()*MAJOR_ARCANA.length); const upright = Math.random()<0.5; return {...MAJOR_ARCANA[idx], upright}; }
function renderCard(c,label){
  const div = document.createElement('div');
  div.className='card';
  div.innerHTML = `<h3>${label?label+'ï¼š':''}${c.zh} <span class="note">(${c.en})</span></h3>
                   <div class="note">ç‰Œåºï¼š${c.n}ã€€æ–¹å‘ï¼š<b>${c.upright ? 'æ­£ä½' : 'é€†ä½'}</b></div>`;
  results.appendChild(div);
}

// ===== Auth wiring =====
loginBtn.onclick = ()=> auth.signInWithPopup(GoogleProvider).catch(e=> alert("ç™»å…¥å¤±æ•—ï¼š"+e.code+"\\n"+e.message));
logoutBtn.onclick = ()=> auth.signOut().catch(e=> alert("ç™»å‡ºå¤±æ•—ï¼š"+e.code+"\\n"+e.message));

auth.onAuthStateChanged(user=>{
  if(user){
    uid = user.uid;
    who.textContent = "å·²ç™»å…¥ï¼š" + (user.displayName || user.email);
    loginBtn.classList.add('hidden');
    logoutBtn.classList.remove('hidden');
    [draw1Btn, draw3Btn, clearBtn].forEach(b=> b.disabled = false);
    attachHistoryListener();
  }else{
    uid = null;
    who.textContent = "æœªç™»å…¥";
    loginBtn.classList.remove('hidden');
    logoutBtn.classList.add('hidden');
    [draw1Btn, draw3Btn, clearBtn].forEach(b=> b.disabled = true);
    historyList.innerHTML = "";
  }
});

// ===== Save / Load =====
function saveDraw(cards){
  saveState.textContent = ""; saveState.className = "note";
  if(!uid){ saveState.textContent = "ï¼ˆæœªç™»å…¥ï¼Œä¸å¯«å…¥ï¼‰"; saveState.className = "note warn"; return; }
  const payload = { cards: cards.map(c=>({n:c.n,en:c.en,zh:c.zh,upright:c.upright})), ts: Date.now() };
  db.ref("tarot_draws/"+uid).push(payload).then(()=>{
    saveState.textContent = "å·²ä¿å­˜åˆ°é›²ç«¯ âœ…";
    saveState.className = "note ok";
  }).catch(e=>{
    saveState.textContent = "ä¿å­˜å¤±æ•— âŒ " + e.message;
    saveState.className = "note err";
  });
}

let historyRef = null;
function attachHistoryListener(){
  if(!db || !uid) return;
  if(historyRef){ historyRef.off(); }
  historyRef = db.ref("tarot_draws/"+uid).limitToLast(100);
  historyRef.on("value", snap=>{
    const val = snap.val() || {};
    const entries = Object.entries(val).map(([key,v])=>({key,...v}));
    entries.sort((a,b)=> (b.ts||0)-(a.ts||0));
    historyList.innerHTML = "";
    entries.forEach(e=>{
      const li = document.createElement("li");
      li.className = "item";
      const when = e.ts ? new Date(e.ts).toLocaleString() : "";
      li.innerHTML = `<div class="meta">${when}</div>` +
        (Array.isArray(e.cards) ? e.cards.map((c,i)=>{
          const label = ["éå»","ç¾åœ¨","æœªä¾†"][i] || "";
          return `<div class="note">${label?label+"ï¼š":""}${c.zh} (${c.en}) â€” <b>${c.upright?"æ­£ä½":"é€†ä½"}</b></div>`;
        }).join("") : "");
      historyList.appendChild(li);
    });
  });
}

// ===== Buttons =====
draw1Btn.onclick = ()=>{
  results.innerHTML='';
  const c = drawOne();
  renderCard(c);
  saveDraw([c]);
};
draw3Btn.onclick = ()=>{
  results.innerHTML='';
  const labels = ['éå»','ç¾åœ¨','æœªä¾†'];
  const cs = [drawOne(), drawOne(), drawOne()];
  cs.forEach((c,i)=> renderCard(c, labels[i]));
  saveDraw(cs);
};
clearBtn.onclick = ()=> results.innerHTML = "";
</script>
</body>
</html>
