<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Coin Intel Chat â€” Google ç™»å…¥ç‰ˆ</title>
<style>
:root{--bg:#0b0f1a;--panel:#0e162f;--line:#1b2550;--text:#eaf1ff;--muted:#9aa8c7;--accent:#5ee1ff;--accent2:#7cffb7;--warn:#ffd166}
*{box-sizing:border-box}
html,body{height:100%;-webkit-text-size-adjust:100%}
body{margin:0;font-family:system-ui,"Noto Sans TC",Arial;background:var(--bg);color:var(--text)}
.app{min-height:100%;display:flex;flex-direction:column}
.container{max-width:1000px;margin:0 auto;flex:1;display:flex;flex-direction:column;padding:12px;gap:10px}
h1{font-size:20px;margin:2px 0 6px}
.topInput{position:sticky;top:0;z-index:3;background:linear-gradient(180deg,rgba(11,15,26,1) 70%, rgba(11,15,26,0.85) 100%);border-bottom:1px solid var(--line);padding-bottom:8px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input[type=text], textarea, button{font-size:16px}
input[type=text]{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1232;color:#eaf1ff}
#nick{flex:1 1 200px}
#msg{flex:1 1 360px;height:52px;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1232;color:#eaf1ff;resize:none;overflow:auto}
button{padding:10px 14px;border:none;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#041923;font-weight:700;cursor:pointer}
button.ghost{background:transparent;border:1px solid var(--line);color:#d9e6ff}
.small{font-size:12px;color:#9aa8c7;margin-top:4px}
.emojiToggle{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#0b1232;color:#d9e6ff;cursor:pointer}
.emojiBar{display:none;gap:6px;flex-wrap:wrap;margin:6px 0 2px}
.emojiBar button{background:#0b1232;border:1px solid var(--line);border-radius:10px;padding:6px 10px;cursor:pointer}
.emojiBar button:hover{border-color:#2b3a7b}
.main{display:grid;grid-template-columns:1fr 300px;gap:10px}
#chat{min-height:300px;max-height:70vh;overflow:auto;padding:12px;border:1px solid var(--line);border-radius:10px;background:var(--panel);display:flex;flex-direction:column;gap:10px}
.msg{margin:0;border:1px solid #17225b;border-radius:10px;padding:8px;background:#0f1738}
.me .name{color:#7cffb7}
.other .name{color:#5ee1ff}
.meta{font-size:11px;color:#9aa8c7;margin-top:4px}
.poll{border:1px solid #2a3470;background:#0b1232;border-radius:10px;padding:8px;margin-top:6px}
.poll .q{font-weight:700;margin-bottom:6px}
.opt{display:flex;justify-content:space-between;align-items:center;gap:8px;margin:6px 0;border:1px solid #22305f;background:#0f193f;border-radius:8px;padding:6px}
.opt button{padding:6px 10px;border-radius:8px;border:1px solid #2a3470;background:#101c44;color:#eaf1ff;cursor:pointer}
.opt .bar{height:8px;background:#1e2a60;border-radius:6px;overflow:hidden;flex:1}
.opt .bar > div{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.side{border:1px solid var(--line);border-radius:10px;background:#0f1530;max-height:70vh;overflow:auto;padding:10px}
.side h3{margin:4px 0 8px}
.stat{display:flex;gap:8px;align-items:center;justify-content:space-between;border-bottom:1px dashed #1b2550;padding:6px 0}
.rank{font-weight:800;color:#9ad7ff}
.lv{font-size:12px;color:#a7ffd6}
.meTag{font-size:11px;color:#ffd166}
#jumpLatest{position:fixed;right:14px;bottom:14px;display:none;border:1px solid var(--line);background:#0b1232;color:#d9e6ff;border-radius:12px;padding:10px 12px;z-index:4}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#142447;border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:10px 14px;color:#eaf1ff;display:none;z-index:5}
.authBar{display:flex;gap:8px;align-items:center;margin-bottom:6px}
.authHint{font-size:12px;color:#ffd166}
@media (max-width:900px){ .main{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="app">
  <div class="container">
    <h1>ğŸ’¬ Coin Intel Chat â€” Google ç™»å…¥ç‰ˆ</h1>

    <div class="topInput">
      <div class="authBar">
        <button id="btnLogin" class="ghost">ç”¨ Google ç™»å…¥</button>
        <button id="btnLogout" class="ghost" style="display:none">ç™»å‡º</button>
        <span id="authInfo" class="small">æœªç™»å…¥</span>
      </div>

      <div class="row" style="margin-bottom:6px">
        <input id="nick" type="text" placeholder="ä½ çš„æš±ç¨±ï¼ˆé è¨­ï¼šGoogle åç¨±ï¼‰" disabled>
        <button id="saveNick" class="ghost" disabled>å„²å­˜æš±ç¨±</button>
      </div>

      <div class="row" style="margin-bottom:4px">
        <button id="toggleEmoji" class="emojiToggle">ğŸ˜Š è¡¨æƒ…</button>
        <div id="emojiBar" class="emojiBar"></div>
      </div>

      <div class="row">
        <textarea id="msg" placeholder="ç™»å…¥å¾Œå³å¯ç™¼è¨€ï¼›Enter é€å‡ºï¼ˆShift+Enter æ›è¡Œï¼‰ã€‚æ”¯æ´ /rankã€/vote ç­‰æŒ‡ä»¤" disabled></textarea>
        <button id="send" disabled>é€å‡º</button>
      </div>
      <div class="small authHint">ï¼Šå¿…é ˆå…ˆç™»å…¥æ‰èƒ½ç™¼è¨€èˆ‡æŠ•ç¥¨ï¼›æ’è¡Œæ¦œä¹Ÿæœƒè¨˜åœ¨ä½ çš„å¸³è™Ÿä¸‹ã€‚</div>
    </div>

    <div class="main">
      <div><div id="chat"></div></div>
      <aside class="side">
        <h3>ğŸ† æ’è¡Œæ¦œï¼ˆè¨Šæ¯æ•¸ï¼‰</h3>
        <div id="leaderboard"></div>
        <div class="small" style="margin-top:8px">ç­‰ç´šè¨ˆç®—ï¼š<code>level = âŒŠâˆš(xp/50)âŒ‹ + 1</code>ï¼›æ¯å‰‡è¨Šæ¯ +10 XPã€‚</div>
      </aside>
    </div>

    <button id="jumpLatest" class="ghost">â†‘ å›åˆ°æœ€æ–°</button>
    <div id="toast" class="toast"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
<script>
// === Firebase ===
const firebaseConfig = {
  apiKey: "AIzaSyC4wMh3OF2yZC74P50HVSVC6juyiK_2iHY",
  authDomain: "coin-intel-chat.firebaseapp.com",
  databaseURL: "https://coin-intel-chat-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "coin-intel-chat",
  appId: "1:829267717115:web:7b0ae1ad3f6289d923b95e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
const GoogleProvider = new firebase.auth.GoogleAuthProvider();

// === DOM ===
const chatBox = document.getElementById("chat");
const msg = document.getElementById("msg");
const send = document.getElementById("send");
const nickInput = document.getElementById("nick");
const saveNickBtn = document.getElementById("saveNick");
const jumpLatest = document.getElementById("jumpLatest");
const emojiBar = document.getElementById("emojiBar");
const toggleEmojiBtn = document.getElementById("toggleEmoji");
const refreshLB = document.getElementById("refreshLB");
const leaderboard = document.getElementById("leaderboard");
const toast = document.getElementById("toast");
const btnLogin = document.getElementById("btnLogin");
const btnLogout = document.getElementById("btnLogout");
const authInfo = document.getElementById("authInfo");

let myId = null;
let myNick = "Guest";

// === UI helpers ===
function showToast(t){ toast.textContent=t; toast.style.display='block'; setTimeout(()=> toast.style.display='none',1800); }
function levelFromXp(xp){ return Math.floor(Math.sqrt((xp||0)/50)) + 1; }
function setInputEnabled(enabled){
  [msg, send, nickInput, saveNickBtn].forEach(el=>{ el.disabled = !enabled; });
}
function setAuthUi(user){
  if(user){
    btnLogin.style.display="none";
    btnLogout.style.display="inline-block";
    authInfo.textContent = `å·²ç™»å…¥ï¼š${user.displayName || user.email}`;
    setInputEnabled(true);
    if(!nickInput.value){ nickInput.value = user.displayName || "Guest"; }
  }else{
    btnLogin.style.display="inline-block";
    btnLogout.style.display="none";
    authInfo.textContent = "æœªç™»å…¥";
    setInputEnabled(false);
  }
}
// === Auth ===
btnLogin.onclick = ()=> auth.signInWithPopup(GoogleProvider).catch(e=>alert("ç™»å…¥å¤±æ•—ï¼š"+e.code+"\\n"+e.message));
btnLogout.onclick = ()=> auth.signOut().catch(e=>alert("ç™»å‡ºå¤±æ•—ï¼š"+e.code+"\\n"+e.message));

auth.onAuthStateChanged(async (user)=>{
  if(user){
    myId = user.uid;
    setAuthUi(user);
    // é è¨­æš±ç¨±
    const defaultNick = user.displayName || "Guest";
    if(!localStorage.getItem("chat_nick")) localStorage.setItem("chat_nick", defaultNick);
    nickInput.value = localStorage.getItem("chat_nick") || defaultNick;
    myNick = nickInput.value || defaultNick;
    // åŒæ­¥ stats çš„æš±ç¨±
    db.ref("stats/"+myId+"/nick").set(myNick).catch(()=>{});
  }else{
    myId = null;
    myNick = "Guest";
    setAuthUi(null);
  }
});

function setNick(v){
  const val = (v||"").trim().slice(0,24) || "Guest";
  localStorage.setItem("chat_nick", val);
  nickInput.value = val;
  if(myId){ db.ref("stats/"+myId+"/nick").set(val).catch(()=>{}); }
}
saveNickBtn.onclick = ()=> setNick(nickInput.value);
nickInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); setNick(nickInput.value);} });

// === Emoji ===
const EMOJIS = ["ğŸ˜„","ğŸ˜‚","ğŸ˜","ğŸ˜","ğŸ¤”","ğŸ˜¢","ğŸ˜¡","ğŸ‘","ğŸ‘","â¤ï¸","ğŸš€","ğŸ’","ğŸ™","ğŸ‰","ğŸ”¥"];
function renderEmojis(){
  emojiBar.innerHTML = "";
  EMOJIS.forEach(e=>{
    const b = document.createElement("button");
    b.type="button"; b.textContent = e;
    b.onclick = ()=> insertAtCursor(msg, e + " ");
    emojiBar.appendChild(b);
  });
}
function insertAtCursor(el, text){
  const start = el.selectionStart ?? el.value.length;
  const end = el.selectionEnd ?? el.value.length;
  const before = el.value.slice(0,start);
  const after  = el.value.slice(end);
  el.value = before + text + after;
  const pos = start + text.length;
  el.setSelectionRange(pos,pos);
  el.focus();
}
toggleEmojiBtn.onclick = ()=>{
  const show = emojiBar.style.display !== "flex";
  emojiBar.style.display = show ? "flex" : "none";
  if(show){ renderEmojis(); }
};

// === Scroll (newest on top) ===
function isAtTop(){ return chatBox.scrollTop <= 6; }
function updateJumpBtn(){ jumpLatest.style.display = isAtTop() ? "none" : "inline-block"; }
chatBox.addEventListener("scroll", updateJumpBtn);
jumpLatest.addEventListener("click", ()=>{ chatBox.scrollTop = 0; updateJumpBtn(); });

// === Poll rendering & vote ===
function renderPoll(m){
  const div = document.createElement("div");
  div.className = "poll";
  const q = document.createElement("div");
  q.className = "q"; q.textContent = m.poll.question || "æŠ•ç¥¨";
  div.appendChild(q);
  const total = (m.poll.options||[]).reduce((s,o)=> s+(o.count||0), 0);
  const myVote = (m.poll.voters && myId && m.poll.voters[myId] !== undefined) ? m.poll.voters[myId] : null;

  (m.poll.options||[]).forEach((opt, idx)=>{
    const row = document.createElement("div");
    row.className = "opt";
    const label = document.createElement("div");
    label.textContent = `${opt.text||("é¸é …"+(idx+1))}  (${opt.count||0})`;
    const barWrap = document.createElement("div"); barWrap.className="bar";
    const pct = total>0 ? Math.round((opt.count||0)*100/total) : 0;
    const bar = document.createElement("div"); bar.style.width = pct+"%";
    barWrap.appendChild(bar);
    const voteBtn = document.createElement("button");
    voteBtn.textContent = (myVote===idx) ? "å·²æŠ•ç¥¨" : "æŠ•ç¥¨";
    if(!myId){ voteBtn.disabled = true; voteBtn.textContent = "è«‹å…ˆç™»å…¥"; }
    if(myVote!==null && myVote!==idx){ voteBtn.disabled = true; }
    voteBtn.onclick = ()=> voteInPoll(m, idx);
    row.appendChild(label); row.appendChild(barWrap); row.appendChild(voteBtn);
    div.appendChild(row);
  });
  return div;
}

function voteInPoll(m, idx){
  if(!myId){ alert("è«‹å…ˆç™»å…¥å†æŠ•ç¥¨"); return; }
  const path = "global/messages/"+m._key+"/poll";
  db.ref(path).transaction(p=>{
    if(!p) return p;
    p.voters = p.voters || {};
    if(p.voters[myId] !== undefined) return p; // already voted
    p.voters[myId] = idx;
    p.options = p.options || [];
    p.options[idx] = p.options[idx] || {text:"",count:0};
    p.options[idx].count = (p.options[idx].count||0)+1;
    return p;
  }).catch(()=>{});
}

// === Commands (ä¸­æ–‡) ===
function levelFromXp(xp){ return Math.floor(Math.sqrt((xp||0)/50)) + 1; }
function handleCommand(text){
  const t = text.trim();
  if(/^\/rank\b/i.test(t)){
    if(!myId){ sendSystem("è«‹å…ˆç™»å…¥å†ä½¿ç”¨ /rank"); return true; }
    db.ref("stats/"+myId).once("value").then(s=>{
      const st = s.val()||{messages:0,xp:0};
      const lv = levelFromXp(st.xp||0);
      sendSystem(`ä½ çš„ç­‰ç´š Lv.${lv}ï½œè¨Šæ¯ ${st.messages||0}ï½œç¶“é©—å€¼ ${st.xp||0}`);
    }); return true;
  }
  if(/^\/roll\b/i.test(t)){
    const num = Math.floor(Math.random()*100)+1;
    sendSystem(`ğŸ² ä½ æ“²å‡ºäº† ${num}`);
    return true;
  }
  if(/^\/gm\b/i.test(t)){ sendSystem("GMï¼è¨˜å¾—å…ˆä¿å€‰ï¼Œå†è«‡å¤¢æƒ³ã€‚"); return true; }
  if(/^\/moon\b/i.test(t)){ const arr=["è¡æœˆçƒå‰ï¼Œå…ˆæƒ³å¥½è½åœ°æ€éº¼ä¸æ‘”æ–·ã€‚","ä¸ç¢ºå®šæ™‚å°±æ”¾å¤§æ™‚é–“è»¸çœ‹ã€‚","é€¢ä½æ‰¿æ¥ï¼Ÿå…ˆå•é¢¨éšªæ‰¿å—åº¦ã€‚","ç¾é‡‘ä¹Ÿæ˜¯ä¸€ç¨®éƒ¨ä½ã€‚"]; sendSystem(arr[Math.floor(Math.random()*arr.length)]); return true; }
  if(/^\/bull\b/i.test(t)){ const arr=["ğŸ‚ ç‰›åœ¨ç†±èº«ï¼Œè«‹è£œæ°´ç­‰å¾…ã€‚","ğŸ‚ ç‰›èªªï¼šæˆäº¤é‡åˆ°ï¼Œæˆ‘å°±åˆ°ã€‚"]; sendSystem(arr[Math.floor(Math.random()*arr.length)]); return true; }
  if(/^\/fortune\b/i.test(t)){ const arr=["ä»Šå¤©åˆ¥è¿½é«˜ï¼Œè®“åƒ¹æ ¼ä¾†æ‰¾ä½ ã€‚","åœæåªæ˜¯é–€ç¥¨ï¼Œç•™å­å½ˆæ‰“ä¸‹ä¸€å±€ã€‚","æ€¥ï¼Œåƒä¸åˆ°ï¼›ç©©ï¼Œæ‰åƒå¾—ä¹…ã€‚","çœ‹æ‡‚é¢¨éšªï¼Œæ”¶ç›Šè‡ªç„¶ä¾†ã€‚","å°‘çœ‹ç›¤ï¼Œå¤šç¡è¦ºã€‚"]; sendSystem(arr[Math.floor(Math.random()*arr.length)]); return true; }
  if(/^\/vote\b/i.test(t)){
    if(!myId){ sendSystem("è«‹å…ˆç™»å…¥å†å»ºç«‹æŠ•ç¥¨"); return true; }
    const raw = t.replace(/^\/vote\s*/i,"");
    const parts = raw.split("|").map(x=>x.trim()).filter(Boolean);
    if(parts.length>=2){
      const question = parts[0];
      const opts = parts.slice(1).map(s=>({text:s,count:0})).slice(0,6);
      createPoll(question, opts);
    }else{
      sendSystem("ç”¨æ³•ï¼š/vote å•é¡Œ | é¸é …1 | é¸é …2");
    }
    return true;
  }
  return false;
}

function sendSystem(text){
  const m={nick:"ç³»çµ±",text,ts:Date.now(),id:"sys"};
  db.ref("global/messages").push(m).catch(e=>alert("ç³»çµ±è¨Šæ¯å¤±æ•—ï¼š"+e.code+"\\n"+e.message));
}
function createPoll(question, options){
  const m={ nick: nickInput.value || "Guest", id: myId, ts:Date.now(), type:"poll", poll:{question, options, voters:{}} };
  db.ref("global/messages").push(m).catch(e=>alert("å»ºç«‹æŠ•ç¥¨å¤±æ•—ï¼š"+e.code+"\\n"+e.message));
}

// === Stats / leaderboard ===
function awardXpOnMessage(){
  if(!myId) return;
  const sref = db.ref("stats/"+myId);
  sref.transaction(s=>{
    s = s || {nick:nickInput.value || "Guest", messages:0, xp:0};
    s.nick = nickInput.value || "Guest";
    s.messages = (s.messages||0)+1;
    s.xp = (s.xp||0)+10;
    s.level = levelFromXp(s.xp);
    s.last = Date.now();
    return s;
  }).catch(()=>{});
}
function loadLeaderboard(){
  db.ref("stats").once("value").then(snap=>{
    const v = snap.val()||{};
    const arr = Object.entries(v).map(([id,s])=>({id,...s}));
    arr.sort((a,b)=> (b.messages||0)-(a.messages||0));
    leaderboard.innerHTML = "";
    arr.slice(0,20).forEach((u,i)=>{
      const row = document.createElement("div");
      row.className="stat";
      row.innerHTML = `<span><span class="rank">#${i+1}</span> ${escapeHtml(u.nick||"Guest")} ${u.id===myId?'<span class="meTag">(ä½ )</span>':''}</span>
                       <span>${u.messages||0} å‰‡ ãƒ» <span class="lv">Lv.${u.level||levelFromXp(u.xp||0)}</span></span>`;
      leaderboard.appendChild(row);
    });
  });
}

// === Send message ===
const ref = db.ref("global/messages");
ref.limitToLast(200).on("child_added", s=>{
  const m=s.val() || {}; m._key = s.key;
  const node = document.createElement("div");
  node.className = "msg "+(m.id && myId && m.id===myId?"me":"other");
  const who = document.createElement("div");
  who.className = "name";
  who.innerHTML = "<b>"+escapeHtml(m.nick||"Guest")+(m.id==="sys"?"ï¼ˆç³»çµ±ï¼‰":"")+"</b>";
  const body = document.createElement("div"); body.textContent = m.text || "";
  const meta = document.createElement("div"); meta.className="meta"; meta.textContent = new Date(m.ts).toLocaleString();
  node.appendChild(who);
  if(m.type==="poll" && m.poll){ node.appendChild(renderPoll(m)); }
  else{ node.appendChild(body); }
  node.appendChild(meta);
  if(chatBox.firstChild){ chatBox.insertBefore(node, chatBox.firstChild); } else { chatBox.appendChild(node); }
  if(isAtTop()){ chatBox.scrollTop = 0; }
  updateJumpBtn();
});

function sendMsg(){
  if(!myId){ alert("è«‹å…ˆç™»å…¥å†ç™¼è¨€"); return; }
  const text=msg.value.trim(); if(!text) return;
  const m={nick:nickInput.value || "Guest",text,ts:Date.now(),id:myId};
  ref.push(m).then(()=>{
    msg.value="";
    chatBox.scrollTop = 0;
    awardXpOnMessage();
  }).catch(e=>{
    alert("âŒ å¯«å…¥å¤±æ•—ï¼š"+e.code+"\\n"+e.message+"\\n\\nè«‹ç¢ºèª Realtime Database è¦å‰‡æ˜¯å¦å·²å…è¨±ç™»å…¥è€…å¯«å…¥ã€‚");
    console.error(e);
  });
}
send.onclick=sendMsg;
msg.addEventListener("keydown",e=>{ if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); sendMsg(); }});

// Utils
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

// Init
loadLeaderboard();
</script>
</body>
</html>