<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Coin Intel Chat â€” æ–°ç•™è¨€åœ¨ä¸Š</title>
<style>
:root{--bg:#0b0f1a;--panel:#0e162f;--line:#1b2550;--text:#eaf1ff;--muted:#9aa8c7;--accent:#5ee1ff;--accent2:#7cffb7}
*{box-sizing:border-box}
html,body{height:100%;-webkit-text-size-adjust:100%}
body{margin:0;font-family:system-ui,"Noto Sans TC",Arial;background:var(--bg);color:var(--text)}
.app{min-height:100%;display:flex;flex-direction:column}
.container{max-width:820px;margin:0 auto;flex:1;display:flex;flex-direction:column;padding:12px;gap:10px}
h1{font-size:20px;margin:2px 0 6px}
/* input area at top (sticky) */
.topInput{position:sticky;top:0;z-index:2;background:linear-gradient(180deg,rgba(11,15,26,1) 70%, rgba(11,15,26,0.85) 100%);border-bottom:1px solid var(--line);padding-bottom:8px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input[type=text], textarea, button{font-size:16px} /* prevent iOS auto-zoom */
input[type=text]{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1232;color:var(--text)}
#nick{flex:1 1 200px}
#msg{flex:1 1 360px;height:52px; padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1232;color:#eaf1ff;resize:none;overflow:auto}
button{padding:10px 14px;border:none;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#041923;font-weight:700;cursor:pointer}
button.ghost{background:transparent;border:1px solid var(--line);color:#d9e6ff}
.small{font-size:12px;color:var(--muted);margin-top:4px}
/* emoji bar */
.emojiToggle{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#0b1232;color:#d9e6ff;cursor:pointer}
.emojiBar{display:none;gap:6px;flex-wrap:wrap;margin:6px 0 2px}
.emojiBar button{background:#0b1232;border:1px solid var(--line);border-radius:10px;padding:6px 10px;cursor:pointer}
.emojiBar button:hover{border-color:#2b3a7b}
/* chat area */
#chat{flex:1;min-height:260px;overflow:auto;padding:12px;border:1px solid var(--line);border-radius:10px;background:var(--panel);display:flex;flex-direction:column;gap:10px}
.msg{margin:0}
.me .name{color:#7cffb7}
.other .name{color:#5ee1ff}
.meta{font-size:11px;color:#9aa8c7;margin-top:2px}
/* jump-to-latest button (scroll to top) */
#jumpLatest{position:fixed;right:14px;bottom:14px;display:none;border:1px solid var(--line);background:#0b1232;color:#d9e6ff;border-radius:12px;padding:10px 12px}
</style>
</head>
<body>
<div class="app">
  <div class="container">
    <h1>ğŸ’¬ Coin Intel Chat</h1>

    <div class="topInput">
      <div class="row" style="margin-bottom:6px">
        <input id="nick" type="text" placeholder="ä½ çš„æš±ç¨±ï¼ˆé è¨­ï¼šGuestï¼‰">
        <button id="saveNick" class="ghost">å„²å­˜æš±ç¨±</button>
      </div>

      <div class="row" style="margin-bottom:4px">
        <button id="toggleEmoji" class="emojiToggle">ğŸ˜Š è¡¨æƒ…</button>
        <div id="emojiBar" class="emojiBar"></div>
      </div>

      <div class="row">
        <textarea id="msg" placeholder="è¼¸å…¥è¨Šæ¯ï¼ŒæŒ‰ Enter é€å‡ºï¼ˆShift+Enter æ›è¡Œï¼‰"></textarea>
        <button id="send">é€å‡º</button>
      </div>
      <div class="small">æœ€æ–°ç•™è¨€é¡¯ç¤ºåœ¨æœ€ä¸Šé¢ï¼›æš±ç¨±è¨˜åœ¨ä½ çš„è£ç½®ï¼ˆlocalStorageï¼‰ã€‚</div>
    </div>

    <div id="chat"></div>
    <button id="jumpLatest" class="ghost">â†‘ å›åˆ°æœ€æ–°</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
<script>
// Firebase è¨­å®šï¼ˆåƒ…ä½¿ç”¨ Realtime Databaseï¼‰
const firebaseConfig = {
  apiKey: "AIzaSyC4wMh3OF2yZC74P50HVSVC6juyiK_2iHY",
  authDomain: "coin-intel-chat.firebaseapp.com",
  databaseURL: "https://coin-intel-chat-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "coin-intel-chat",
  appId: "1:829267717115:web:7b0ae1ad3f6289d923b95e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// DOM refs
const chat = document.getElementById("chat");
const msg = document.getElementById("msg");
const send = document.getElementById("send");
const jumpLatest = document.getElementById("jumpLatest");
const nickInput = document.getElementById("nick");
const saveNickBtn = document.getElementById("saveNick");
const toggleEmojiBtn = document.getElementById("toggleEmoji");
const emojiBar = document.getElementById("emojiBar");

let myId = Math.random().toString(36).slice(2,8);

// æš±ç¨±ï¼šlocalStorage è¨˜æ†¶
function getNick(){
  const n = localStorage.getItem("chat_nick");
  return (n && n.trim()) ? n.trim().slice(0,24) : "Guest";
}
function setNick(v){
  const val = (v||"").trim().slice(0,24);
  localStorage.setItem("chat_nick", val || "Guest");
  nickInput.value = val;
}
nickInput.value = localStorage.getItem("chat_nick") || "";
saveNickBtn.onclick = () => setNick(nickInput.value);
nickInput.addEventListener("change", ()=> setNick(nickInput.value));
nickInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); setNick(nickInput.value);} });

// è¡¨æƒ…æ¸…å–®
const EMOJIS = ["ğŸ˜„","ğŸ˜‚","ğŸ˜","ğŸ˜","ğŸ¤”","ğŸ˜¢","ğŸ˜¡","ğŸ‘","ğŸ‘","â¤ï¸","ğŸš€","ğŸ’","ğŸ™","ğŸ‰","ğŸ”¥"];
function renderEmojis(){
  emojiBar.innerHTML = "";
  EMOJIS.forEach(e=>{
    const b = document.createElement("button");
    b.type="button"; b.textContent = e;
    b.onclick = ()=> insertAtCursor(msg, e + " ");
    emojiBar.appendChild(b);
  });
}
function insertAtCursor(el, text){
  const start = el.selectionStart ?? el.value.length;
  const end = el.selectionEnd ?? el.value.length;
  const before = el.value.slice(0,start);
  const after  = el.value.slice(end);
  el.value = before + text + after;
  const pos = start + text.length;
  el.setSelectionRange(pos,pos);
  el.focus();
}
toggleEmojiBtn.onclick = ()=>{
  const show = emojiBar.style.display !== "flex";
  emojiBar.style.display = show ? "flex" : "none";
  if(show){ renderEmojis(); }
};

// æ²å‹•åˆ¤æ–·ï¼ˆé ‚éƒ¨ï¼æœ€æ–°ï¼‰
function isAtTop(){ return chat.scrollTop <= 6; }
function updateJumpBtn(){ jumpLatest.style.display = isAtTop() ? "none" : "inline-block"; }
chat.addEventListener("scroll", updateJumpBtn);
jumpLatest.addEventListener("click", ()=>{ chat.scrollTop = 0; updateJumpBtn(); });

function addMsgNode(m, isMe){
  const wrap=document.createElement("div");
  wrap.className="msg "+(isMe?"me":"other");
  const name = document.createElement("div");
  name.className = "name";
  name.innerHTML = `<b>${(m.nick||"Guest")}</b>`;
  const body = document.createElement("div");
  body.textContent = m.text || "";
  const meta = document.createElement("div");
  meta.className="meta";
  meta.textContent = new Date(m.ts).toLocaleString();
  wrap.appendChild(name); wrap.appendChild(body); wrap.appendChild(meta);
  return wrap;
}

function addMsg(m, isMe){
  const atTop = isAtTop();
  const node = addMsgNode(m, isMe);
  // å°‡æ–°è¨Šæ¯æ’å…¥åˆ°å®¹å™¨æœ€å‰é¢ï¼ˆæœ€æ–°åœ¨ä¸Šï¼‰
  if(chat.firstChild){ chat.insertBefore(node, chat.firstChild); }
  else{ chat.appendChild(node); }
  // å¦‚æœåŸæœ¬å°±åœ¨é ‚ç«¯ï¼Œå°±ä¿æŒé ‚ç«¯ï¼ˆé¿å…è¢«æ¨ä¸‹å»ï¼‰
  if(atTop){ chat.scrollTop = 0; }
  updateJumpBtn();
}

// è¼‰å…¥èˆ‡å³æ™‚
const ref = db.ref("global/messages");
ref.limitToLast(200).on("child_added", s=>{
  const m = s.val() || {};
  addMsg(m, m.id===myId);
});

function sendMsg(){
  const text = msg.value.trim(); if(!text) return;
  const payload = { nick:getNick(), text, ts:Date.now(), id:myId };
  db.ref("global/messages").push(payload).then(()=>{
    msg.value="";
    // é€å‡ºå¾ŒæŠŠè¦–åœ–è·³å›é ‚ç«¯ï¼ˆæœ€æ–°ï¼‰
    chat.scrollTop = 0;
  });
}
send.onclick = sendMsg;
msg.addEventListener("keydown", e=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMsg(); }
});

// åˆå§‹
setTimeout(()=>{ try{ msg.focus(); }catch{} }, 10);
</script>
</body>
</html>
