<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Coin Intel Chat â€” å³æ™‚èŠå¤©å®¤ï¼ˆå«åœ–ç‰‡ä¸Šå‚³ï¼‰</title>
<style>
:root{--bg:#0b0f1a;--text:#eaf1ff;--muted:#9aa8c7;--accent:#5ee1ff;--accent2:#7cffb7}
*{box-sizing:border-box}
body{margin:0;background:
  radial-gradient(1000px 600px at 90% -10%,rgba(94,225,255,.12),transparent 60%),
  radial-gradient(900px 600px at -20% 110%,rgba(124,255,183,.10),transparent 60%),var(--bg);
  color:var(--text);font-family:system-ui,"Noto Sans TC","Segoe UI",Roboto,Arial}
.container{max-width:900px;margin:0 auto;padding:16px}
.header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.header h1{margin:0;font-size:22px}
a.link{margin-left:auto;color:#5ee1ff;text-decoration:none}
.card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;overflow:hidden}
.topbar{display:flex;gap:10px;flex-wrap:wrap;padding:12px;border-bottom:1px solid rgba(255,255,255,.08)}
input[type=text]{flex:1 1 160px;padding:10px 12px;border:1px solid rgba(255,255,255,.15);border-radius:10px;background:#0c1331;color:var(--text)}
button{border:none;padding:10px 14px;border-radius:12px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#041923;font-weight:800;cursor:pointer}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,.2);color:var(--text)}
.chat{height:58vh;min-height:360px;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
.msg{display:flex;gap:10px;align-items:flex-end}
.bubble{max-width:78%;padding:10px 12px;border-radius:12px;background:#0f1b3f;border:1px solid rgba(255,255,255,.08)}
.me .bubble{background:#0f2f3f}
.meta{font-size:11px;color:var(--muted);margin-top:4px}
.username{font-weight:700;color:#86f7ff}
.sys{align-self:center;color:#9aa8c7;font-size:12px}
.err{align-self:center;color:#ffb3b3;font-size:12px}
.inputbar{display:flex;gap:10px;padding:12px;border-top:1px solid rgba(255,255,255,.08);flex-wrap:wrap}
textarea{flex:1 1 320px;height:52px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0c1331;color:#eaf1ff;resize:none}
.small{font-size:12px;color:var(--muted);margin-top:8px}
.img{max-width:100%;border-radius:10px;border:1px solid rgba(255,255,255,.12);display:block}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.progress{height:6px;background:#11224e;border-radius:999px;overflow:hidden;flex:1 1 120px;min-width:120px}
.progress>div{height:100%;width:0;background:linear-gradient(90deg,#5ee1ff,#7cffb7)}
@media (max-width:720px){
  .chat{height:62vh}
  .bubble{max-width:85%}
  .header h1{font-size:18px}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ’¬ Coin Intel Chat</h1>
    <a class="link" href="./">å›åˆ°ä¸»é </a>
  </div>

  <div class="card">
    <div class="topbar">
      <input id="nick" type="text" placeholder="ä½ çš„æš±ç¨±ï¼ˆé è¨­ï¼šGuestï¼‰">
      <input id="room" type="text" placeholder="æˆ¿é–“åç¨±ï¼ˆé è¨­ï¼šglobalï¼‰">
      <button id="join">åŠ å…¥ / åˆ‡æ›æˆ¿é–“</button>
      <button class="ghost" id="copyLink">è¤‡è£½æˆ¿é–“é€£çµ</button>
    </div>

    <div id="chat" class="chat"></div>

    <div class="inputbar">
      <textarea id="text" placeholder="è¼¸å…¥è¨Šæ¯ï¼ŒæŒ‰ Enter é€å‡ºï¼ˆShift+Enter æ›è¡Œï¼‰"></textarea>
      <div class="row">
        <input id="file" type="file" accept="image/*" style="display:none">
        <button id="pick" class="ghost">ğŸ“· ä¸Šå‚³åœ–ç‰‡</button>
        <div class="progress" id="pg" style="display:none"><div id="pgbar"></div></div>
      </div>
      <button id="send">é€å‡º</button>
    </div>
  </div>

  <p class="small">â€¢ æ”¯æ´ä¸Šå‚³åœ–ç‰‡ï¼ˆé è¨­ 5MB ä»¥å…§ï¼‰ã€‚<br>â€¢ è‹¥é¡¯ç¤ºé›¢ç·šï¼Œè«‹ç¢ºèª Realtime Database èˆ‡ Storage å·²å•Ÿç”¨ä¸”è¦å‰‡å…è¨±è®€å¯«ï¼ˆæ¸¬è©¦æœŸå¯å…ˆå…¨é–‹ï¼‰ã€‚</p>
</div>

<!-- Firebase compat CDN -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>

<script>
// === ä½ çš„ Firebase è¨­å®šï¼ˆå«æ­£ç¢º databaseURLï¼‰===
const firebaseConfig = {
  apiKey: "AIzaSyC4wMh3OF2yZC74P50HVSVC6juyiK_2iHY",
  authDomain: "coin-intel-chat.firebaseapp.com",
  databaseURL: "https://coin-intel-chat-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "coin-intel-chat",
  storageBucket: "coin-intel-chat.firebasestorage.app",
  messagingSenderId: "829267717115",
  appId: "1:829267717115:web:7b0ae1ad3f6289d923b95e",
  measurementId: "G-VNEXPQY3G1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

// === DOM ===
const $ = s => document.querySelector(s);
const chat = $("#chat"), txt = $("#text"), nick = $("#nick"), room = $("#room");
const fileInput = $("#file"), pickBtn = $("#pick"), pg = $("#pg"), pgbar = $("#pgbar");
let roomRef = null, currentRoom = "global";
let myId = Math.random().toString(36).slice(2,8);

// æš±ç¨±æŒä¹…åŒ–
(function(){
  const savedNick = localStorage.getItem("chat_nick");
  if(savedNick) nick.value = savedNick;
  const p = new URLSearchParams(location.search);
  const r = p.get("room"); if(r) room.value = r;
})();

function addRow(cls,text){
  const d=document.createElement("div"); d.className=cls; d.textContent=text; chat.appendChild(d); chat.scrollTop=chat.scrollHeight;
}
function addSys(t){ addRow("sys", t); }
function addErr(t){ addRow("err", t); }

function escapeHTML(s){return s.replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]))}

function addMsg(m, isMe){
  const row = document.createElement("div"); row.className = "msg"+(isMe?" me":"");
  const bubble = document.createElement("div"); bubble.className = "bubble";
  let body = `<div class="username">${escapeHTML(m.nick||"Guest")}</div>`;
  if(m.imgUrl){
    body += `<a href="${m.imgUrl}" target="_blank"><img class="img" src="${m.imgUrl}" alt="${escapeHTML(m.imgName||'image')}"></a>`;
    if(m.text){ body += `<div>${escapeHTML(m.text)}</div>`; }
  }else{
    body += (escapeHTML(m.text||"")).replace(/\\n/g,"<br>");
  }
  body += `<div class="meta">${new Date(m.ts||Date.now()).toLocaleString()}</div>`;
  bubble.innerHTML = body;
  row.appendChild(bubble); chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
}

function bindConnectionIndicator(){
  db.ref(".info/connected").on("value", s=>{
    if(s.val()===true){ addSys("âœ… å·²é€£ç·š Firebase"); }
    else{ addErr("âŒ é›¢ç·šä¸­ï¼ˆè«‹ç¢ºèªè³‡æ–™åº«è¦å‰‡èˆ‡ Storage è¦å‰‡ï¼‰"); }
  });
}

function join(newRoom){
  if(roomRef){ roomRef.off(); }
  currentRoom = newRoom || "global";
  chat.innerHTML = "";
  addSys(`ä½ åŠ å…¥äº†æˆ¿é–“ #${currentRoom}`);
  roomRef = db.ref("rooms/"+currentRoom+"/messages");
  roomRef.limitToLast(100).on("child_added", snap=>{
    const m = snap.val()||{};
    addMsg(m, m.clientId===myId);
  });
  bindConnectionIndicator();
}

function sendText(){
  const textVal = txt.value.trim();
  if(!textVal) return;
  const n = (nick.value.trim() || "Guest").slice(0,24);
  localStorage.setItem("chat_nick", n);
  const data = { nick: n, text: textVal.slice(0,1000), ts: Date.now(), clientId: myId };
  db.ref("rooms/"+currentRoom+"/messages").push(data)
    .then(()=>{ txt.value=""; })
    .catch(err=> addErr("æ–‡å­—å¯«å…¥å¤±æ•—ï¼š"+err.message));
}

function sendImage(file){
  if(!file) return;
  if(file.size > 5*1024*1024){ addErr("åœ–ç‰‡å¤ªå¤§ï¼Œè«‹å°æ–¼ 5MB"); return; }
  const n = (nick.value.trim() || "Guest").slice(0,24);
  localStorage.setItem("chat_nick", n);
  const key = `${Date.now()}-${Math.random().toString(36).slice(2,8)}-${file.name}`;
  const path = `rooms/${currentRoom}/uploads/${key}`;
  const ref = storage.ref(path);
  const task = ref.put(file, {contentType:file.type||"image/*"});
  pg.style.display="block";
  task.on("state_changed",
    (snap)=>{
      const p = Math.round((snap.bytesTransferred/snap.totalBytes)*100);
      pgbar.style.width = p + "%";
    },
    (err)=>{ addErr("ä¸Šå‚³å¤±æ•—ï¼š"+err.message); pg.style.display="none"; pgbar.style.width="0"; },
    ()=>{
      task.snapshot.ref.getDownloadURL().then((url)=>{
        const data = {
          nick: n, ts: Date.now(), clientId: myId,
          imgUrl: url, imgName: file.name, imgSize: file.size,
          text: txt.value.trim().slice(0,300) || null
        };
        db.ref("rooms/"+currentRoom+"/messages").push(data)
          .then(()=>{ txt.value=""; pg.style.display="none"; pgbar.style.width="0"; })
          .catch(err=> addErr("è¨Šæ¯å¯«å…¥å¤±æ•—ï¼š"+err.message));
      });
    }
  );
}

// events
document.getElementById("send").onclick = sendText;
txt.addEventListener("keydown",(e)=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault(); sendText();
  }
});

document.getElementById("join").onclick = ()=>{
  const r = (room.value.trim()||"global");
  join(r);
  const url = new URL(location.href); url.searchParams.set("room", r);
  history.replaceState({}, "", url.toString());
};

document.getElementById("copyLink").onclick = ()=>{
  const url = new URL(location.href); url.searchParams.set("room", currentRoom);
  navigator.clipboard.writeText(url.toString()).then(()=>addSys("å·²è¤‡è£½æˆ¿é–“é€£çµ"));
};

pickBtn.onclick = ()=> fileInput.click();
fileInput.onchange = ()=> sendImage(fileInput.files[0]);

// init
join(room.value.trim() || "global");
</script>

</body>
</html>
